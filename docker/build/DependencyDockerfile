ARG PYTHON_VERSION
ARG JAVA_VERSION
FROM eclipse-temurin:${JAVA_VERSION}-jre as java-jre
ARG PYTHON_VERSION
ARG JAVA_VERSION
FROM python:${PYTHON_VERSION}-slim AS builder
ENV build_dir = "/usr/local/lib/${PYTHON_VERSION}/site-packages"
ARG PYTHON_VERSION
ARG JAVA_VERSION
ARG LIVY_VERSION
ARG SPARK_VERSION
# Install dependencies and cleanup in a single layer
RUN apt-get update && apt-get -y upgrade && apt-get -y install tree libkrb5-dev pkg-config libmpfr-dev libgmp-dev libmpc-dev libgirepository1.0-dev libcairo2-dev build-essential wget curl unzip \
    && python -m pip install --upgrade pip \
    && rm -rf /var/lib/apt/lists/*

RUN mkdir /artifacts && mkdir /artifacts/python-packages-fabric && mkdir /artifacts/python-packages-app

# Handle Python dependencies
ADD versions/${SPARK_VERSION}/fabric_requirements.txt /tmp/
ADD versions/${SPARK_VERSION}/app_requirements.txt /tmp/
RUN pip download --no-deps -r /tmp/fabric_requirements.txt && rm /tmp/fabric_requirements.txt -d /artifacts/python-packages-fabric
RUN pip download -r /tmp/app_requirements.txt && rm /tmp/app_requirements.txt  -d /artifacts/python-packages-app

###########################################
# Install Apache Livy
###########################################

#Set Livy variables
ENV LIVY_PORT=8998 \
    LIVY_HOME=/opt/livy \
    LIVY_CONF_DIR="${LIVY_HOME}/conf"

RUN curl --progress-bar -L --retry 3 \
    "https://archive.apache.org/dist/incubator/livy/${LIVY_VERSION}/apache-livy-${LIVY_VERSION}_2.12-bin.zip" \
    -o "/tmp/apache-livy-${LIVY_VERSION}_2.12-bin.zip" \
  && unzip -qq "/tmp/apache-livy-${LIVY_VERSION}_2.12-bin.zip" -d /tmp/ \
  && mv /tmp/apache-livy-${LIVY_VERSION}_2.12-bin ${LIVY_HOME} \
  && rm "/tmp/apache-livy-${LIVY_VERSION}_2.12-bin.zip" \
  && mkdir "${LIVY_HOME}/logs" \
  && chown -R root:root "${LIVY_HOME}"

COPY livy/conf/livy.conf /usr/livy/conf/livy.conf

# Set environment variables
ENV JAVA_HOME=/opt/java/openjdk \
    PATH="${JAVA_HOME}/bin:${PATH}"

RUN mv /usr/local/bin /artifacts/bin
RUN mv $LIVY_HOME /artifacts/livy
# Copy the Java Runtime Environment (JRE) from the eclipse-temurin image
COPY --from=java-jre $JAVA_HOME /artifacts/java


# Add an entrypoint to keep the container running
ENTRYPOINT ["tail", "-f", "/dev/null